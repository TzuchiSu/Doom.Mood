<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Doom.mood</title>
  <style>
    :root {
      --bg: #0b0d10;
      --fg: #f1f5f9;
      --muted: #94a3b8;
      --accent: #22d3ee;
    }
    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      overflow: hidden; /* 因為是滿版視圖 */
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    /* 滿版容器 */
    #stage {
      position: fixed;
      inset: 0;
      background: #000;
      overflow: hidden;
      isolation: isolate;
      display: grid; /* center when empty */
      place-items: center;
    }

    .slide {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      will-change: transform, opacity;
      overflow: hidden; /* 確保溢出的圖片不會露出 */
    }

    /* 桌面優先 cover；手機透過 media query 改成 contain（你要的行為） */
    .slide img {
      height: 100vh;   /* 以視窗高度為主，desktop 用 cover */
      width: auto;
      object-fit: cover;
      object-position: center center;
      display: block;
      margin: 0 auto;
      user-select: none;
      -webkit-user-drag: none;
      pointer-events: none;
      filter: saturate(0.95) contrast(1.02);
    }

    /* 浮動資訊列 */
    #hud {
      position: fixed;
      left: 1rem;
      bottom: 1rem;
      right: 1rem;
      display: grid;
      gap: .4rem;
      pointer-events: none;
      z-index: 10;
    }
    .row { display: flex; gap: .6rem; align-items: center; flex-wrap: wrap; }

    .pill {
      pointer-events: auto;
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.25);
      color: var(--fg);
      border-radius: 999px;
      padding: .45rem .7rem;
      font-size: .9rem;
      backdrop-filter: blur(6px);
      white-space: nowrap;
    }

    /* 針對 credits（動態加入的）用不同 class，避免干擾 controls 的樣式 */
    .pill.credit {
      /* 如果想要 credits 跟 controls 不一樣，可在此微調 */
      font-size: .82rem;
    }

    .kbd {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: rgba(30, 41, 59, 0.85);
      color: var(--fg);
      border: 1px solid rgba(148, 163, 184, 0.3);
      padding: .1rem .45rem;
      border-radius: .4rem;
      box-shadow: inset 0 -1px 0 rgba(255,255,255,0.05);
    }

    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }

    /* 螢幕上的方向按鈕（可觸控） */
    #dpad {
      position: fixed;
      top: 1rem; right: 1rem;
      display: grid; grid-template-columns: 48px 48px 48px; grid-template-rows: 48px 48px 48px;
      gap: 6px; z-index: 12; pointer-events: auto;
      opacity: .85;
    }
    #dpad button{
      background: rgba(15,23,42,.55);
      border: 1px solid rgba(148,163,184,.35);
      color: var(--fg);
      border-radius: .6rem;
      font-size: 14px; backdrop-filter: blur(6px);
      cursor: pointer;
    }
    #dpad button:active{ transform: scale(.98); }
    #dpad .empty{ visibility: hidden; }

    /* 載入中指示 */
    #spinner{
      position: fixed; inset: 0; display: grid; place-items: center; z-index: 11; pointer-events: none;
      transition: opacity .25s ease; opacity: 0;
    }
    #spinner.show{ opacity: 1; }
    .dot{
      width: 10px; height: 10px; margin: 0 5px; border-radius: 50%; background: var(--fg);
      animation: bounce 1s infinite ease-in-out alternate;
    }
    .dot:nth-child(2){ animation-delay: .15s; }
    .dot:nth-child(3){ animation-delay: .3s; }
    @keyframes bounce { from{ transform: translateY(0) } to{ transform: translateY(-8px) } }
    /* Top-left logo */
    #logo{ position: fixed; top: 12px; left: 12px; height: 100px; width: auto; z-index: 20; opacity: .95; }
    /* Startup background cover（desktop: cover） */
    #bg{ position: absolute; inset: 0; display: grid; place-items: center; z-index: 0; overflow: hidden; }
    #bg img{
      height: 100vh;
      width: auto;
      object-fit: cover;
      object-position: center center;
      display: block;
      margin: 0 auto;
    }

    /* 小螢幕調整：手機維持 contain 行為，且特別鎖定 controls 的字級（避免動態變大） */
    @media (max-width: 600px) {
      /* 手機：圖片改為 contain，確保不會被強制裁切 */
      .slide img {
        max-height: 100vh;
        max-width: 100vw;
        height: auto;
        width: auto;
        object-fit: contain;
        object-position: center center;
        display: block;
        margin: 0 auto;
      }
      #bg img{
        max-height: 100vh;
        max-width: 100vw;
        height: auto;
        width: auto;
        object-fit: contain;
        object-position: center center;
        display: block;
        margin: 0 auto;
      }

      /* 調整一般 pill 與 kbd（整體縮小） */
      .pill { font-size: .75rem; padding: .35rem .5rem; }
      .kbd  { font-size: .78rem; padding: .08rem .35rem; }

      /* 鎖定 controls row（避免滑動或動態加入其他 .pill 影響 controls 大小） */
      /* 我把第一行加上 .controls-row（見 HTML），並指定 controls 類別 */
      #hud .controls-row .controls {
        font-size: .62rem;
        padding: .3rem .5rem;
        white-space: normal;   /* 允許換行，會自動分成兩行（兩個 pill 會斷行） */
        line-height: 1.25;
      }

      #hud { left: .6rem; right: .6rem; bottom: .8rem; }
      #logo { height: 72px; top: 8px; left: 8px; }
      #dpad { top: 8px; right: 8px; gap: 4px; grid-template-columns: 40px 40px 40px; grid-template-rows: 40px 40px 40px; }
      #dpad button { font-size: 12px; border-radius: .45rem; }
    }

    /* 更小的手機（例如舊型手機） */
    @media (max-width: 380px) {
      #hud .controls-row .controls { font-size: .58rem; padding: .26rem .42rem; }
      .pill { font-size: .68rem; padding: .25rem .4rem; }
      .kbd  { font-size: .72rem; }
      #logo { height: 56px; }
    }
  </style>
</head>
<body>
  <div id="stage" aria-live="polite">
    <div id="bg"><img src="assets/BG.png" alt="Background cover"></div>
  </div>
  <img id="logo" src="assets/Logo.png" alt="Logo"/>

  <!-- 注意：我把第一個 row 加上 .controls-row，並把兩個 pill 都加上 controls 類別，這樣在小螢幕會穩定呈現為兩行（可換行），且其字級不會被後續動態 credit 影響 -->
  <div id="hud">
    <div class="row controls-row">
      <span class="pill controls">Controls: <span class="kbd">↑</span> The Met, <span class="kbd">↓</span> Internet Archive (random), <span class="kbd">←</span> Internet Archive (news), <span class="kbd">→</span> Wikimedia Commons</span>
      <span class="pill controls">Each press → fetches a new full-screen image</span>
    </div>
    <!-- creditRow 用於動態插入來源資訊，我會讓 setCredit 插入的 pill 帶上 .credit 類別，避免干擾 controls 的樣式 -->
    <div class="row" id="creditRow" style="display:none"></div>
  </div>

  <div id="dpad" aria-label="On-screen arrow pad">
    <button class="empty" disabled></button>
    <button id="btnUp">↑</button>
    <button class="empty" disabled></button>
    <button id="btnLeft">←</button>
    <button class="empty" disabled></button>
    <button id="btnRight">→</button>
    <button class="empty" disabled></button>
    <button id="btnDown">↓</button>
    <button class="empty" disabled></button>
  </div>

  <div id="spinner"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>

  <script>
    // ========= Config =========
    // 已移除 Unsplash，改做「新聞影像」來源（GDELT）不需 key
    const stage = document.getElementById('stage');
    const creditRow = document.getElementById('creditRow');
    const spinner = document.getElementById('spinner');

    function setSpinner(on){ spinner.classList.toggle('show', !!on); }

    // 注意：在這裡動態插入的 pill 都標記為 class="pill credit"，以免改變 controls 的樣式
    function setCredit({ title, author, sourceName, sourceUrl }){
      const html = [];
      if (title) html.push(`<span class="pill credit">${title}</span>`);
      if (author) html.push(`<span class="pill credit">by ${author}</span>`);
      if (sourceName || sourceUrl) {
        const text = sourceName || sourceUrl;
        const link = sourceUrl ? `<a href="${sourceUrl}" target="_blank" rel="noopener">${text}</a>` : text;
        html.push(`<span class="pill credit">${link}</span>`);
      }
      creditRow.innerHTML = html.join("\n");
      creditRow.style.display = html.length ? 'flex' : 'none';
    }

    // ========= Fetchers（極簡版：直接回傳單一 URL） =========
    // ↑ The Met（無需 key）
    async function fetchMetRandom(){
      if (!fetchMetRandom._ids || fetchMetRandom._ids.length === 0){
        const res = await fetch('https://collectionapi.metmuseum.org/public/collection/v1/search?hasImages=true&q=*');
        const data = await res.json();
        fetchMetRandom._ids = data.objectIDs || [];
      }
      if (!fetchMetRandom._ids.length) throw new Error('MET: no objectIDs');
      for (let i=0;i<8;i++){
        const id = fetchMetRandom._ids[Math.floor(Math.random()*fetchMetRandom._ids.length)];
        const r = await fetch(`https://collectionapi.metmuseum.org/public/collection/v1/objects/${id}`);
        const obj = await r.json();
        const full = obj.primaryImage || obj.additionalImages?.[0] || obj.primaryImageSmall;
        const thumb = obj.primaryImageSmall || full;
        if (full){
          return { thumbUrl: thumb, fullUrl: full, title: obj.title||'The Met', author: obj.artistDisplayName||'', sourceName: 'The Met', sourceUrl: obj.objectURL||'https://www.metmuseum.org/art/collection' };
        }
      }
      throw new Error('MET: failed');
    }

    // ↓ Internet Archive（無需 key）。策略：Advanced Search 抓一批 identifier → /metadata → 選一張 JPG/PNG。
    async function fetchIARandom(){
      const page = 1 + Math.floor(Math.random()*50);
      const searchUrl = `https://archive.org/advancedsearch.php?q=mediatype%3A(image)&fl%5B%5D=identifier&rows=50&page=${page}&output=json`;
      const res = await fetch(searchUrl);
      const data = await res.json();
      const docs = data?.response?.docs || [];
      if (!docs.length) throw new Error('IA: no docs');
      for (let t=0;t<12;t++){
        const id = docs[Math.floor(Math.random()*docs.length)].identifier;
        const meta = await (await fetch(`https://archive.org/metadata/${id}`)).json();
        const files = meta?.files || [];
        const big = files.filter(f=>/\.(jpe?g|png)$/i.test(f.name) && !/thumb|small|icon/i.test(f.name));
        const small = files.filter(f=>/\.(jpe?g|png)$/i.test(f.name) && /thumb|small|icon|medium/i.test(f.name));
        const fullF = big[0] || small[0];
        const thumbF = small[0] || big[0];
        if (fullF){
          return { thumbUrl:`https://archive.org/download/${id}/${encodeURIComponent(thumbF.name)}`, fullUrl:`https://archive.org/download/${id}/${encodeURIComponent(fullF.name)}`, title: meta?.metadata?.title||id, author: (meta?.metadata?.creator||'').toString(), sourceName: 'Internet Archive', sourceUrl: `https://archive.org/details/${id}` };
        }
      }
      throw new Error('IA: no image file');
    }

    // ← Internet Archive：偏新聞影像（無需 key）。以關鍵字 news/newspaper/press 搜尋圖片型態的項目。
    async function fetchIANewsRandom(){
      const queries=[
        'mediatype:(image) AND (news OR newspaper OR press OR headline)',
        'mediatype:(image) AND (frontpage OR journal OR periodical)',
        'mediatype:(image) AND (magazine AND news)'
      ];
      const q = encodeURIComponent(queries[Math.floor(Math.random()*queries.length)]);
      const page = 1 + Math.floor(Math.random()*50);
      const searchUrl = `https://archive.org/advancedsearch.php?q=${q}&fl%5B%5D=identifier&rows=50&page=${page}&output=json`;
      const data = await (await fetch(searchUrl)).json();
      const docs = data?.response?.docs || [];
      if (!docs.length) throw new Error('IA News: no docs');
      for (let t=0;t<14;t++){
        const id = docs[Math.floor(Math.random()*docs.length)].identifier;
        const meta = await (await fetch(`https://archive.org/metadata/${id}`)).json();
        const files = meta?.files || [];
        const big = files.filter(f=>/\.(jpe?g|png)$/i.test(f.name) && !/thumb|small|icon/i.test(f.name));
        const small = files.filter(f=>/\.(jpe?g|png)$/i.test(f.name) && /thumb|small|icon|medium/i.test(f.name));
        const fullF = big[0] || small[0];
        const thumbF = small[0] || big[0];
        if (fullF){
          return { thumbUrl:`https://archive.org/download/${id}/${encodeURIComponent(thumbF.name)}`, fullUrl:`https://archive.org/download/${id}/${encodeURIComponent(fullF.name)}`, title: meta?.metadata?.title||id, author: (meta?.metadata?.creator||'').toString(), sourceName: 'Internet Archive (news)', sourceUrl: `https://archive.org/details/${id}` };
        }
      }
      throw new Error('IA News: no image');
    }

    // → Wikimedia Commons（無需 key）。用 generator=random + prop=imageinfo 取縮圖（較快），保留來源連結。
    async function fetchCommonsRandom(){
      const u = 'https://commons.wikimedia.org/w/api.php?action=query&generator=random&grnnamespace=6&prop=imageinfo|info&iiprop=url|extmetadata&iiurlheight=900&format=json&inprop=url&origin=*';
      const j = await (await fetch(u)).json();
      const pages = j?.query?.pages ? Object.values(j.query.pages) : [];
      if (!pages.length) throw new Error('Commons: no pages');
      for (const p of pages){
        const ii = p.imageinfo && p.imageinfo[0];
        const thumb = ii?.thumburl || ii?.url;
        const full = ii?.url || thumb;
        if (thumb){
          const em = ii.extmetadata || {};
          return { thumbUrl: thumb, fullUrl: full, title:(em.ObjectName && em.ObjectName.value)||p.title||'Wikimedia Commons', author:(em.Artist && em.Artist.value && em.Artist.value.replace(/<[^>]+>/g,''))||'', sourceName: 'Wikimedia Commons', sourceUrl: `https://commons.wikimedia.org/wiki/${encodeURIComponent(p.title)}` };
        }
      }
      throw new Error('Commons: failed');
    }

    // ========= View: slide-in 轉場（縮圖 → 大圖） =========
    async function showFromDirection(direction){
      setSpinner(true);
      let payload;
      try {
        if (direction === 'up') payload = await fetchMetRandom();
        else if (direction === 'down') payload = await fetchIARandom();
        else if (direction === 'left') payload = await fetchIANewsRandom();
        else if (direction === 'right') payload = await fetchCommonsRandom();
      } catch(err){
        console.error(err);
        payload = { thumbUrl:`https://picsum.photos/seed/${Date.now()%100000}/900/1200`, fullUrl:`https://picsum.photos/seed/${Date.now()%100000}/1800/2400`, title: err.message||'Error', author:'', sourceName:'', sourceUrl:'' };
      }

      const slide = document.createElement('div');
      slide.className = 'slide';

      // 先放縮圖
      const img = new Image();
      img.decoding = 'async';
      img.loading = 'eager';
      img.referrerPolicy = 'no-referrer'; // 避免 IA 401
      const chosen = payload.thumbUrl || payload.fullUrl || payload.url;
      img.src = chosen;
      // IA 401/403 備援：改用 /serve/ 端點；最後退回 Picsum
      img.onerror = () => {
        if ((payload.sourceName||'').startsWith('Internet Archive') && chosen) {
          try {
            const m = chosen.match(/download\/([^/]+)\/(.+)$/);
            if (m) {
              img.onerror = null;
              img.src = `https://archive.org/serve/${m[1]}/${m[2]}`;
              return;
            }
          } catch(_){}
        }
        img.src = `https://picsum.photos/seed/${Date.now()%100000}/1600/900`;
      };
      slide.appendChild(img);

      const w = stage.clientWidth, h = stage.clientHeight;
      let startX = 0, startY = 0;
      if (direction === 'left') startX = -w;
      if (direction === 'right') startX = w;
      if (direction === 'up') startY = -h;
      if (direction === 'down') startY = h;
      slide.style.transform = `translate(${startX}px, ${startY}px)`;
      slide.style.opacity = '0.8';

      const prev = stage.querySelector('.slide:last-of-type');
      stage.appendChild(slide);

      try{ await img.decode(); }catch(_){ }

      const ANIM_MS = 420;
      slide.animate([
        { transform: `translate(${startX}px, ${startY}px)`, opacity: .8 },
        { transform: 'translate(0, 0)', opacity: 1 }
      ], { duration: ANIM_MS, easing: 'cubic-bezier(.2,.7,.2,1)', fill: 'forwards' });

      if (prev){
        prev.animate([
          { transform: 'translate(0,0)', opacity: 1 },
          { transform: `translate(${-startX*0.25}px, ${-startY*0.25}px)`, opacity: 0 }
        ], { duration: ANIM_MS, easing: 'cubic-bezier(.2,.7,.2,1)', fill: 'forwards' })
        .addEventListener('finish', () => prev.remove());
      }

      // 預載大圖並替換
      if (payload.fullUrl && payload.fullUrl !== payload.thumbUrl){
        const hi = new Image();
        hi.decoding = 'async';
        hi.src = payload.fullUrl;
        try { await hi.decode(); } catch(_) {}
        img.src = payload.fullUrl;
      }
      img.animate([
        { filter: 'blur(6px)' },
        { filter: 'blur(0px)' }
      ], { duration: 220, easing: 'ease-out', fill: 'forwards' });

      setCredit(payload);
      if (!window.__bgHidden){ const bg = document.getElementById('bg'); if (bg) bg.style.display='none'; window.__bgHidden=true; }
      setSpinner(false);
    }

    // ========= Controls =========
    const keyMap = {
      ArrowUp: 'up', ArrowDown: 'down', ArrowLeft: 'left', ArrowRight: 'right',
      w: 'up', s: 'down', a: 'left', d: 'right'
    };

    let busy = false; // 節流，避免連按造成重疊

    // 將 trigger 掛到 window，讓鋼琴模組能包裝它以出聲（也能被觸控使用）
    window.trigger = async function(dir){
      if (busy) return; busy = true;
      await showFromDirection(dir);
      busy = false;
    };

    window.addEventListener('keydown', (e) => {
      const dir = keyMap[e.key];
      if (dir){
        e.preventDefault();
        window.trigger(dir);
      }
    });

    // 阻止鋼琴模組重複綁定（我們統一透過包裝的 window.trigger 出聲）
    window.__pianoKeyListenerAttached = true;
    ['Up','Down','Left','Right'].forEach(k=>{
      const el = document.getElementById('btn'+k);
      if (el) el.__pianoHooked = true;
    });

    document.getElementById('btnUp').onclick = () => window.trigger('up');
    document.getElementById('btnDown').onclick = () => window.trigger('down');
    document.getElementById('btnLeft').onclick = () => window.trigger('left');
    document.getElementById('btnRight').onclick = () => window.trigger('right');

    // 觸控滑動（直覺映射：上滑→down、右滑→left），並由 window.trigger 統一出聲
    (function(){
      if (window.__swipeInstalled) return; window.__swipeInstalled = true;
      let sx=0, sy=0; const THRESH=48;
      window.addEventListener('touchstart', (e)=>{ const t=e.touches[0]; if(!t) return; sx=t.clientX; sy=t.clientY; }, { passive:true });
      window.addEventListener('touchend', (e)=>{ const t=e.changedTouches[0]; if(!t) return; const dx=t.clientX-sx, dy=t.clientY-sy; if (Math.abs(dx)<THRESH && Math.abs(dy)<THRESH) return;
        const raw = Math.abs(dx) > Math.abs(dy) ? (dx>0?'right':'left') : (dy>0?'down':'up');
        const map = { up:'down', down:'up', left:'right', right:'left' };
        const dir = map[raw] || raw;
        window.trigger(dir);
      }, { passive:true });
    })();

    // 起始先載一張（任選來源）
    window.trigger('up');
  </script>

  <!-- Offline piano samples (HTMLAudio, no external CDN) -->
  <script>
    (function(){
      if (window.__pianoInstalled) return; // 避免重複安裝
      window.__pianoInstalled = true;

      const PIANO_LOCAL = {
        up:   'assets/piano/C5.mp3',  // 8 (高音 Do)
        down: 'assets/piano/E5.mp3',  // 3 (高音 Mi)
        left: 'assets/piano/B4.mp3',  // 7 (高音 Ti)
        right:'assets/piano/D5.mp3'   // 2 (高音 Re)
      };

      const sounds = {};
      for (const k in PIANO_LOCAL){
        const a = new Audio();
        a.src = PIANO_LOCAL[k];
        a.preload = 'auto';
        a.crossOrigin = 'anonymous';
        a.volume = 0.9;
        sounds[k] = a;
      }

      // 解鎖：第一次手勢播放極短靜音
      let audioUnlocked = false;
      async function unlockAudio(){
        if (audioUnlocked) return;
        try {
          const s = new Audio('assets/piano/C5.mp3');
          s.volume = 0.0001; // nearly silent
          const p = s.play();
          if (p && typeof p.then === 'function') await p;
          s.pause();
          audioUnlocked = true;
        } catch(e) {
          console.warn('unlock failed', e);
        }
      }
      window.addEventListener('pointerdown', unlockAudio, { once:true });
      window.addEventListener('keydown', unlockAudio, { once:true });

      function playPiano(dir){
        const a = sounds[dir];
        if (!a) return;
        try { a.currentTime = 0; a.play(); } catch(e){ console.error('audio play failed', e); }
      }

      // 與 trigger 串接（所有來源：鍵盤、D-pad、滑動都走這裡，因此都會有音效）
      if (typeof window.trigger === 'function' && !window.__pianoTriggerWrapped){
        const prev = window.trigger;
        window.trigger = async function(dir){ playPiano(dir); return prev(dir); };
        window.__pianoTriggerWrapped = true;
      }

      // 若未被預先阻止，保留鍵盤與 D-pad 的備援綁定（目前主程式已預先標記避免雙重綁定）
      if (!window.__pianoKeyListenerAttached){
        window.addEventListener('keydown', (e)=>{ const d = {ArrowUp:'up', ArrowDown:'down', ArrowLeft:'left', ArrowRight:'right', w:'up', s:'down', a:'left', d:'right'}[e.key]; if (d) playPiano(d); }, { passive:true });
        window.__pianoKeyListenerAttached = true;
      }
      [['Up','up'],['Down','down'],['Left','left'],['Right','right']].forEach(([k,d])=>{
        const el = document.getElementById('btn'+k);
        if (el && !el.__pianoHooked){ el.addEventListener('click', ()=> playPiano(d)); el.__pianoHooked = true; }
      });
    })();
  </script>
</body>
</html>
